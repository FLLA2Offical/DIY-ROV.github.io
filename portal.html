<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Team 69310 and 69309 Portal</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
<style>
:root {
  --primary-blue: #002D62;
  --accent-orange: #FF7300;
  --text-light: #ffffff;
}
* { box-sizing: border-box; margin:0; padding:0; font-family: Arial,sans-serif; }
body { background: var(--primary-blue); color: var(--text-light); overflow-x:hidden; }

/* Header */
header { 
  background: var(--accent-orange); 
  padding: 15px; 
  text-align:center; 
  height:110px; 
  box-sizing:border-box;
  position: fixed; 
  top:0; 
  left:0; 
  width:100%;
  z-index:1000;
}
header img { max-height: 80px; margin-bottom:8px; }
h1 { font-size:1.8em; margin:0; }

/* Sidebar */
#sidebar {
  position: fixed; 
  top: 110px; /* below header */
  left:0; 
  width: 250px; 
  height: calc(100% - 110px); 
  background: #001d3d;
  padding-top: 10px;
  transition: 0.3s; 
  overflow-x:hidden; 
  transform: translateX(-250px);
  z-index:999;
}
#sidebar.show { transform: translateX(0); }
#sidebar button { width:100%; padding: 15px; text-align:left; border:none; background:none; color:var(--text-light); font-size:1em; cursor:pointer; border-bottom:1px solid #333; }
#sidebar button:hover { background: var(--accent-orange); color:#000; }

/* Sidebar toggle button */
#toggleSidebar { position: fixed; top:15px; left:15px; font-size:1.5em; cursor:pointer; background:none; border:none; color:var(--text-light); z-index:1001; }

/* Main content */
main { 
  margin-left:0; 
  padding:20px; 
  padding-top:130px; /* space for header */
  transition: margin-left 0.3s; 
  min-height: calc(100vh - 110px);
}
main.showSidebar { margin-left:250px; }

/* Common Styles for Pages */
.page { display:none; }
input[type="file"], .webcam-btn, .reset-button, button { border:none; border-radius:6px; padding:10px 20px; background: var(--accent-orange); color:var(--text-light); cursor:pointer; margin:5px; }
input[type="color"] { margin:10px; padding:5px; border-radius:5px; border:none; cursor:pointer; }
input[type="file"]:disabled, .webcam-btn[disabled] { background:#888; cursor:not-allowed; }
img, video, canvas { border:4px solid var(--accent-orange); border-radius:10px; max-width:90%; margin:15px auto; display:block; }
.bar-container { width:90%; max-width:350px; margin:6px auto; background:#ddd; border-radius:8px; overflow:hidden; }
.bar { height:20px; text-align:left; padding-left:8px; line-height:20px; color:#fff; font-size:0.9em; background:var(--accent-orange); transition: width 0.3s ease; }
.spinner { border:6px solid #f3f3f3; border-top:6px solid var(--accent-orange); border-radius:50%; width:40px; height:40px; animation: spin 1s linear infinite; margin:20px auto; display:none; }
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Change Color Page */
#gradientPreview { width:80%; height:150px; margin:20px auto; border:3px solid var(--accent-orange); border-radius:10px; background: linear-gradient(90deg,#002D62,#FF7300); }

/* Chat Page */
#chatContainer {
  width: 100%;
  height: calc(100vh - 20px); /* full height */
  overflow-y: auto;
}
#chatContainer iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* Footer */
footer { background:#001d3d; color:#ccc; text-align:center; padding:12px; margin-top:40px; font-size:0.9em; }
</style>
</head>
<body>
<header id="mainHeader">
<img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRdHi23XxqOV9z8ZQ0pF_c3G-jwIhXylPvJKg&s" alt="Team 69310 Logo">
<h1>Team 69310 and 69309 Portal</h1>
</header>

<button id="toggleSidebar">&#9776;</button>
<div id="sidebar">
<button onclick="showPage('objectPage')">Object Identifier</button>
<button onclick="showPage('rockPage')">Rock Identifier</button>
<button onclick="showPage('colorPage')">Change Color</button>
<button onclick="showPage('chatPage')">Team Chat</button>
</div>

<main id="mainContent">
<!-- Object Identifier -->
<div class="page" id="objectPage">
<h2>Object Identifier</h2>
<p>Upload an image or use your webcam:</p>
<input id="objFile" type="file" accept="image/*" onchange="loadObjectImage(event)" disabled>
<button class="reset-button" id="objReset" onclick="resetObject()" disabled>Reset</button>
<br>
<img id="objImage" alt="Uploaded Preview">
<div class="spinner" id="objSpinner"></div>
<div class="webcam-controls">
<button id="objStart" class="webcam-btn" onclick="startObjectWebcam()" disabled>Start Webcam</button>
<button id="objStop" class="webcam-btn" onclick="stopObjectWebcam()" disabled>Stop Webcam</button>
<button id="objSwitch" class="webcam-btn" onclick="switchObjectCamera()" disabled>Switch Camera</button>
<video id="objWebcam" playsinline autoplay muted></video>
<div id="objLiveBadge">Live classification runningâ€¦</div>
</div>
<div id="objResult" aria-live="polite">Loading AI model...</div>
</div>

<!-- Rock Identifier -->
<div class="page" id="rockPage">
<h2>Rock Identifier</h2>
<p>Upload image or use webcam:</p>
<input id="rockFile" type="file" accept="image/*" onchange="loadRockImage(event)">
<div id="rockStatus"></div>
<div id="rockWebcamContainer"></div>
<div id="rockLabelContainer"></div>
<img id="rockImage" alt="Uploaded Preview">
<div id="rockResult"></div>
<button onclick="startRockWebcam()">Start Webcam</button>
<button onclick="switchRockCamera()">Switch Camera</button>
<button onclick="stopRockWebcam()">Stop Webcam</button>
</div>

<!-- Change Color -->
<div class="page" id="colorPage">
<h2>Change Background</h2>
<p>Pick a solid color or set a gradient:</p>
<input type="color" id="solidColor" value="#002D62">
<input type="color" id="gradientStart" value="#002D62">
<input type="color" id="gradientEnd" value="#FF7300">
<div id="gradientPreview"></div>
<button onclick="applySolid()">Apply Solid</button>
<button onclick="applyGradient()">Apply Gradient</button>
</div>

<!-- Team Chat -->
<div class="page" id="chatPage">
  <h2>Team Chat (Password Protected)</h2>
  <input type="password" id="chatPassword" placeholder="Enter Password">
  <button id="chatSubmit" onclick="checkPassword()">Enter</button>

  <div id="chatContainer" style="display:none;">
    <iframe src="https://deadsimplechat.com/rJ02_uAhy"></iframe>
    <button class="open-chat-button" onclick="window.open('https://deadsimplechat.com/rJ02_uAhy', '_blank')">
      Open in new tab
    </button>
  </div>
</div>

<style>
  .open-chat-button {
    background: linear-gradient(135deg, #007BFF, #FF7F50);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
    margin-top: 15px;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  .open-chat-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
  }

  .open-chat-button:active {
    transform: translateY(1px);
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
  }
</style>

<footer>
&copy; 2025 Team 69310 and 69309 Collegiate. All rights reserved.
</footer>

<script>
// ---------------- Sidebar ----------------
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const headerEl = document.getElementById('mainHeader');
document.getElementById('toggleSidebar').onclick = () => {
  sidebar.classList.toggle('show');
  mainContent.classList.toggle('showSidebar');
};

function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.getElementById(id).style.display='block';

  // Show or hide header based on chat page
  if(id === 'chatPage'){ headerEl.style.display='none'; }
  else { headerEl.style.display='block'; }

  sidebar.classList.remove('show'); mainContent.classList.remove('showSidebar');
}

// ---------------- Object Identifier ----------------
let objNet, objWebcamStream=null, objWebcamRunning=false, objCurrentFacing="environment", objLoop=null;

async function loadObjectModel(){
  const resEl=document.getElementById('objResult');
  resEl.textContent="Loading AI model...";
  objNet = await mobilenet.load({version:2, alpha:0.75});
  resEl.textContent="Model loaded. Upload image or start webcam.";
  document.getElementById('objFile').disabled=false;
  document.getElementById('objStart').disabled=false;
  document.getElementById('objReset').disabled=false;
  document.getElementById('objStop').disabled=false;
  document.getElementById('objSwitch').disabled=false;
}

async function loadObjectImage(event){
  const img=document.getElementById('objImage');
  const resEl=document.getElementById('objResult');
  const spinner=document.getElementById('objSpinner');
  img.src=URL.createObjectURL(event.target.files[0]);
  img.style.display='block';
  spinner.style.display='block';
  resEl.textContent="Analyzing...";
  img.onload = async ()=>{
    const results = await objNet.classify(img);
    spinner.style.display='none';
    showObjResults(results);
    URL.revokeObjectURL(img.src);
  }
}
function showObjResults(results){
  const resEl=document.getElementById('objResult');
  if(results && results.length){
    resEl.innerHTML = results.slice(0,3).map(r=>{
      const percent=(r.probability*100).toFixed(2);
      return `<div>${r.className} - ${percent}%</div>
      <div class="bar-container"><div class="bar" style="width:${percent}%">${percent}%</div></div>`;
    }).join('');
  }else resEl.textContent="No prediction.";
}
function resetObject(){
  const img=document.getElementById('objImage');
  const resEl=document.getElementById('objResult');
  const fileInput=document.getElementById('objFile');
  img.style.display='none'; img.src='';
  resEl.textContent="Upload new image or start webcam.";
  fileInput.value='';
}

// Object Webcam
async function startObjectWebcam(){
  const video=document.getElementById('objWebcam');
  try{
    objWebcamStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:objCurrentFacing}, audio:false});
    video.srcObject=objWebcamStream;
    await video.play();
    objWebcamRunning=true;
    runObjWebcamLoop();
  } catch(e){ alert("Cannot access webcam."); }
}
function stopObjectWebcam(){
  objWebcamRunning=false;
  if(objLoop) cancelAnimationFrame(objLoop);
  if(objWebcamStream){ objWebcamStream.getTracks().forEach(t=>t.stop()); objWebcamStream=null; }
  document.getElementById('objWebcam').srcObject=null;
}
let lastTs=0; const INTERVAL=500;
async function runObjWebcamLoop(ts){
  if(!objWebcamRunning) return;
  objLoop=requestAnimationFrame(runObjWebcamLoop);
  if(!lastTs || ts-lastTs>=INTERVAL){
    lastTs=ts;
    const results=await objNet.classify(document.getElementById('objWebcam'));
    showObjResults(results);
  }
}
async function switchObjectCamera(){ 
  objCurrentFacing=(objCurrentFacing==="environment")?"user":"environment";
  stopObjectWebcam(); 
  await startObjectWebcam(); 
}

// ---------------- Rock Identifier ----------------
const ROCK_MODEL_URL="https://teachablemachine.withgoogle.com/models/IZwfz2mDI/";
let rockModel, rockWebcam=null, rockLabelContainer, rockMaxPredictions, rockRunning=false, rockFacing="environment";

async function loadRockModel(){ 
  if(rockModel) return;
  const status=document.getElementById('rockStatus'); 
  status.textContent="Loading rock model...";
  rockModel=await tmImage.load(ROCK_MODEL_URL+"model.json", ROCK_MODEL_URL+"metadata.json");
  rockMaxPredictions=rockModel.getTotalClasses();
  status.textContent="Model loaded!";
}

async function loadRockImage(event){
  if(!rockModel) await loadRockModel();
  const file=event.target.files[0]; if(!file) return;
  const img=document.getElementById('rockImage'); const res=document.getElementById('rockResult');
  res.innerHTML=""; img.style.display='none';
  const url=URL.createObjectURL(file); img.src=url;
  img.onload=async ()=>{
    const predictions=await rockModel.predict(img);
    predictions.sort((a,b)=>b.probability-a.probability);
    img.style.display='block';
    res.innerHTML=predictions.slice(0,3).map(p=>{
      const per=(p.probability*100).toFixed(2);
      return `<div>${p.className} - ${per}%</div><div class="bar-container"><div class="bar" style="width:${per}%">${per}%</div></div>`;
    }).join('');
    URL.revokeObjectURL(url);
  }
}

// Rock Webcam
async function startRockWebcam(){
  if(!rockModel) await loadRockModel();
  if(rockRunning) return;
  rockWebcam=new tmImage.Webcam(300,300,false);
  await rockWebcam.setup({facingMode:rockFacing}); 
  await rockWebcam.play(); 
  rockRunning=true;
  const container=document.getElementById('rockWebcamContainer'); container.innerHTML=""; container.appendChild(rockWebcam.canvas);
  rockLabelContainer=document.getElementById('rockLabelContainer'); rockLabelContainer.innerHTML="";
  for(let i=0;i<rockMaxPredictions;i++){
    let wrap=document.createElement('div');
    wrap.innerHTML=`<div></div><div class="bar-container"><div class="bar"></div></div>`;
    rockLabelContainer.appendChild(wrap);
  }
  requestAnimationFrame(rockLoop);
}
function stopRockWebcam(){ 
  if(rockWebcam && rockRunning){ 
    rockWebcam.stop(); rockRunning=false; 
    document.getElementById('rockWebcamContainer').innerHTML=""; 
    document.getElementById('rockLabelContainer').innerHTML=""; 
  }
}
async function switchRockCamera(){ 
  rockFacing=(rockFacing==="user")?"environment":"user"; 
  stopRockWebcam(); 
  await startRockWebcam(); 
}
async function rockLoop(){ 
  if(!rockRunning) return; 
  rockWebcam.update(); 
  const pred=await rockModel.predict(rockWebcam.canvas); 
  pred.sort((a,b)=>b.probability-a.probability); 
  for(let i=0;i<pred.length;i++){ 
    const percent=(pred[i].probability*100).toFixed(2); 
    const wrap=rockLabelContainer.childNodes[i]; 
    wrap.querySelector("div").textContent=`${pred[i].className}: ${percent}%`; 
    wrap.querySelector(".bar").style.width=percent+"%"; 
    wrap.querySelector(".bar").textContent=percent+"%"; 
  }
  requestAnimationFrame(rockLoop);
}

// ---------------- Change Color ----------------
const preview=document.getElementById('gradientPreview');
function applySolid(){ preview.style.background=document.getElementById('solidColor').value; document.body.style.background=preview.style.background;}
function applyGradient(){ preview.style.background=`linear-gradient(90deg, ${document.getElementById('gradientStart').value}, ${document.getElementById('gradientEnd').value})`; document.body.style.background=preview.style.background;}

// ---------------- Chat ----------------
function checkPassword(){
  const pw=document.getElementById('chatPassword').value;
  if(pw==="GOCSR"){ 
    document.getElementById('chatContainer').style.display='block'; 
    document.getElementById('chatPassword').style.display='none'; 
    document.getElementById('chatSubmit').style.display='none'; 
  } else { alert("Incorrect password."); }
}

loadObjectModel();
</script>
</body>
</html>
